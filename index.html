<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>R√°dio Supermercado do Louro</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            transition: all 0.3s ease;
        }

        .container {
            max-width: 1200px;
            width: 90%;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1rem;
        }

        /* Player P√∫blico */
        .player-container {
            text-align: center;
            margin-bottom: 30px;
        }

        .album-cover {
            width: 300px;
            height: 300px;
            border-radius: 15px;
            margin: 0 auto 20px;
            background: rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .album-cover img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .player-info {
            margin-bottom: 20px;
        }

        .current-track {
            font-size: 1.3rem;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .track-type {
            opacity: 0.8;
            margin-bottom: 20px;
        }

        .player-controls {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            margin-bottom: 20px;
        }

        .play-btn {
            background: #4CAF50;
            border: none;
            color: white;
            padding: 15px 30px;
            border-radius: 50px;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(76, 175, 80, 0.4);
        }

        .play-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(76, 175, 80, 0.6);
        }

        .play-btn:disabled {
            background: #666;
            cursor: not-allowed;
        }

        .volume-control {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .volume-slider {
            width: 100px;
            height: 5px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 5px;
            outline: none;
            -webkit-appearance: none;
        }

        .volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 15px;
            height: 15px;
            background: #4CAF50;
            border-radius: 50%;
            cursor: pointer;
        }

        /* Bot√µes de Modo */
        .mode-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 30px;
        }

        .mode-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .mode-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        .mode-btn.active {
            background: #4CAF50;
            border-color: #4CAF50;
        }

        /* Painel Admin */
        .admin-panel {
            display: none;
        }

        .admin-section {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .admin-section h3 {
            margin-bottom: 15px;
            color: #4CAF50;
        }

        .upload-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .upload-group {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 10px;
        }

        .upload-group h4 {
            margin-bottom: 10px;
            color: #81C784;
        }

        .file-input {
            width: 100%;
            padding: 10px;
            border: 2px dashed rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            margin-bottom: 10px;
        }

        .upload-btn {
            background: #4CAF50;
            border: none;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            width: 100%;
            transition: all 0.3s ease;
        }

        .upload-btn:hover {
            background: #45a049;
        }

        .album-selection {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .album-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .album-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }

        .album-card.active {
            border-color: #4CAF50;
            background: rgba(76, 175, 80, 0.2);
        }

        .album-card img {
            width: 100%;
            height: 120px;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .file-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: rgba(255, 255, 255, 0.1);
            margin-bottom: 5px;
            border-radius: 8px;
        }

        .delete-btn {
            background: #f44336;
            border: none;
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.8rem;
        }

        .delete-btn:hover {
            background: #d32f2f;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #4CAF50;
        }

        .password-prompt {
            text-align: center;
            margin-bottom: 20px;
        }

        .password-input {
            padding: 12px;
            border: none;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.9);
            color: #333;
            margin-right: 10px;
            width: 200px;
        }

        .login-btn {
            background: #4CAF50;
            border: none;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .login-btn:hover {
            background: #45a049;
        }

        .report-section {
            max-height: 400px;
            overflow-y: auto;
        }

        .report-item {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            background: rgba(255, 255, 255, 0.1);
            margin-bottom: 5px;
            border-radius: 8px;
        }

        .reset-btn {
            background: #ff9800;
            border: none;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            margin-bottom: 15px;
        }

        .reset-btn:hover {
            background: #f57c00;
        }

        .hidden {
            display: none;
        }

        .loading {
            text-align: center;
            padding: 20px;
            opacity: 0.7;
        }

        .error {
            background: rgba(244, 67, 54, 0.2);
            border: 1px solid #f44336;
            color: #ffcdd2;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .success {
            background: rgba(76, 175, 80, 0.2);
            border: 1px solid #4CAF50;
            color: #c8e6c9;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        @media (max-width: 768px) {
            .container {
                width: 95%;
                padding: 20px;
            }

            .header h1 {
                font-size: 2rem;
            }

            .album-cover {
                width: 250px;
                height: 250px;
            }

            .upload-section {
                grid-template-columns: 1fr;
            }

            .album-selection {
                grid-template-columns: 1fr;
            }

            .stats {
                grid-template-columns: 1fr;
            }

            .password-input {
                width: 150px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéµ R√°dio Supermercado do Louro</h1>
            <p>Sua trilha sonora perfeita para compras</p>
        </div>

        <!-- Bot√µes de Modo -->
        <div class="mode-buttons">
            <button class="mode-btn active" id="publicMode">üéß Modo P√∫blico</button>
            <button class="mode-btn" id="adminMode">üõ†Ô∏è Modo Admin</button>
        </div>

        <!-- Player P√∫blico -->
        <div id="publicPlayer" class="player-container">
            <div class="album-cover" id="albumCover">
                <img src="" alt="Capa do √Ålbum" id="coverImage" style="display: none;">
                <span id="coverText">üéµ Supermercado do Louro</span>
            </div>

            <div class="player-info">
                <div class="current-track" id="currentTrack">Aguardando m√∫sica...</div>
                <div class="track-type" id="trackType">Pronto para tocar</div>
            </div>

            <div class="player-controls">
                <button class="play-btn" id="playBtn">‚ñ∂Ô∏è Iniciar R√°dio</button>
                <div class="volume-control">
                    <span>üîä</span>
                    <input type="range" class="volume-slider" id="volumeSlider" min="0" max="100" value="50">
                    <span id="volumeValue">50%</span>
                </div>
            </div>

            <audio id="audioPlayer" preload="auto"></audio>
        </div>

        <!-- Painel Admin -->
        <div id="adminPanel" class="admin-panel">
            <div class="password-prompt" id="passwordPrompt">
                <h3>üîí Acesso Restrito</h3>
                <input type="password" class="password-input" id="passwordInput" placeholder="Digite a senha">
                <button class="login-btn" id="loginBtn">Acessar</button>
            </div>

            <div id="adminContent" class="hidden">
                <!-- Upload de Arquivos -->
                <div class="admin-section">
                    <h3>üìÅ Upload de Arquivos</h3>
                    <div class="upload-section">
                        <div class="upload-group">
                            <h4>üéµ M√∫sicas Principais</h4>
                            <input type="file" class="file-input" id="musicUpload" accept="audio/*" multiple>
                            <button class="upload-btn" onclick="uploadFiles('musicas')">Upload M√∫sicas</button>
                        </div>
                        
                        <div class="upload-group">
                            <h4>üïê Hora Certa</h4>
                            <input type="file" class="file-input" id="timeUpload" accept="audio/*" multiple>
                            <button class="upload-btn" onclick="uploadFiles('hora-certa')">Upload Hora Certa</button>
                        </div>
                        
                        <div class="upload-group">
                            <h4>üì¢ Avisos</h4>
                            <input type="file" class="file-input" id="adUpload" accept="audio/*" multiple>
                            <button class="upload-btn" onclick="uploadFiles('avisos')">Upload Avisos</button>
                        </div>
                        
                        <div class="upload-group">
                            <h4>üéä √Ålbuns Tem√°ticos</h4>
                            <input type="file" class="file-input" id="albumUpload" accept="audio/*" multiple>
                            <button class="upload-btn" onclick="uploadFiles('albuns')">Upload √Ålbuns</button>
                        </div>
                    </div>
                </div>

                <!-- Sele√ß√£o de √Ålbum -->
                <div class="admin-section">
                    <h3>üéä √Ålbuns Tem√°ticos</h3>
                    <div class="album-selection" id="albumSelection">
                        <div class="album-card" data-album="natal">
                            <img src="https://via.placeholder.com/200x120/ff0000/ffffff?text=NATAL" alt="Natal">
                            <h4>üéÑ Natal</h4>
                        </div>
                        <div class="album-card" data-album="pascoa">
                            <img src="https://via.placeholder.com/200x120/ffeb3b/333333?text=P√ÅSCOA" alt="P√°scoa">
                            <h4>üê∞ P√°scoa</h4>
                        </div>
                        <div class="album-card" data-album="sao-joao">
                            <img src="https://via.placeholder.com/200x120/ff9800/ffffff?text=S√ÉO+JO√ÉO" alt="S√£o Jo√£o">
                            <h4>üåΩ S√£o Jo√£o</h4>
                        </div>
                        <div class="album-card" data-album="none">
                            <img src="https://via.placeholder.com/200x120/9e9e9e/ffffff?text=DESATIVAR" alt="Desativar">
                            <h4>‚ùå Desativar</h4>
                        </div>
                    </div>
                </div>

                <!-- Estat√≠sticas -->
                <div class="admin-section">
                    <h3>üìä Estat√≠sticas</h3>
                    <div class="stats">
                        <div class="stat-card">
                            <div class="stat-number" id="totalSongs">0</div>
                            <div>Total de M√∫sicas</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="totalPlayed">0</div>
                            <div>M√∫sicas Tocadas</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="currentAlbum">Nenhum</div>
                            <div>√Ålbum Ativo</div>
                        </div>
                    </div>
                </div>

                <!-- Relat√≥rio de Reprodu√ß√£o -->
                <div class="admin-section">
                    <h3>üìã Relat√≥rio de Reprodu√ß√£o</h3>
                    <button class="reset-btn" onclick="resetPlayReport()">üîÑ Resetar Relat√≥rio</button>
                    <div class="report-section" id="playReport">
                        <div class="loading">Carregando relat√≥rio...</div>
                    </div>
                </div>

                <!-- Lista de Arquivos -->
                <div class="admin-section">
                    <h3>üìÇ Arquivos Enviados</h3>
                    <div class="file-list" id="fileList">
                        <div class="loading">Carregando arquivos...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // Configura√ß√£o Supabase
        const SUPABASE_URL = 'https://yrlwyvvlgrjbwnoiwdxv.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlybHd5dnZsZ3JqYndub2l3ZHh2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg4MDk0OTMsImV4cCI6MjA2NDM4NTQ5M30.qrNDx8aqL2WtWPalhmjzeUY6bCNVnnK48L2Oi2DpkVI';
        
        // Configura√ß√µes globais
        const CONFIG = {
            adminPassword: 'admin123',
            buckets: {
                musicas: 'musicas',
                'hora-certa': 'hora-certa',
                avisos: 'avisos',
                albuns: 'albuns'
            },
            albums: {
                natal: {
                    name: 'Natal',
                    image: 'https://via.placeholder.com/300x300/ff0000/ffffff?text=NATAL',
                    folder: 'natal'
                },
                pascoa: {
                    name: 'P√°scoa',
                    image: 'https://via.placeholder.com/300x300/ffeb3b/333333?text=P√ÅSCOA',
                    folder: 'pascoa'
                },
                'sao-joao': {
                    name: 'S√£o Jo√£o',
                    image: 'https://via.placeholder.com/300x300/ff9800/ffffff?text=S√ÉO+JO√ÉO',
                    folder: 'sao-joao'
                }
            }
        };

        // Estado da aplica√ß√£o
        let currentState = {
            isPlaying: false,
            currentTrack: null,
            trackQueue: [],
            playCount: 0,
            musicCount: 0,
            timeCount: 0,
            adCount: 0,
            isLoggedIn: false,
            activeAlbum: localStorage.getItem('activeAlbum') || null,
            volume: localStorage.getItem('volume') || 50,
            playReport: JSON.parse(localStorage.getItem('playReport') || '[]'),
            allFiles: {
                musicas: [],
                'hora-certa': [],
                avisos: [],
                albuns: []
            }
        };

        // Elementos DOM
        const elements = {
            // Modo
            publicMode: document.getElementById('publicMode'),
            adminMode: document.getElementById('adminMode'),
            publicPlayer: document.getElementById('publicPlayer'),
            adminPanel: document.getElementById('adminPanel'),
            
            // Player
            audioPlayer: document.getElementById('audioPlayer'),
            playBtn: document.getElementById('playBtn'),
            currentTrack: document.getElementById('currentTrack'),
            trackType: document.getElementById('trackType'),
            volumeSlider: document.getElementById('volumeSlider'),
            volumeValue: document.getElementById('volumeValue'),
            albumCover: document.getElementById('albumCover'),
            coverImage: document.getElementById('coverImage'),
            coverText: document.getElementById('coverText'),
            
            // Admin
            passwordPrompt: document.getElementById('passwordPrompt'),
            passwordInput: document.getElementById('passwordInput'),
            loginBtn: document.getElementById('loginBtn'),
            adminContent: document.getElementById('adminContent'),
            albumSelection: document.getElementById('albumSelection'),
            
            // Uploads
            musicUpload: document.getElementById('musicUpload'),
            timeUpload: document.getElementById('timeUpload'),
            adUpload: document.getElementById('adUpload'),
            albumUpload: document.getElementById('albumUpload'),
            
            // Stats
            totalSongs: document.getElementById('totalSongs'),
            totalPlayed: document.getElementById('totalPlayed'),
            currentAlbum: document.getElementById('currentAlbum'),
            playReport: document.getElementById('playReport'),
            fileList: document.getElementById('fileList')
        };

        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', init);

        function init() {
            setupEventListeners();
            loadVolume();
            updateAlbumCover();
            loadFiles();
            updateStats();
        }

        function setupEventListeners() {
            // Modo
            elements.publicMode.addEventListener('click', () => switchMode('public'));
            elements.adminMode.addEventListener('click', () => switchMode('admin'));
            
            // Player
            elements.playBtn.addEventListener('click', togglePlay);
            elements.volumeSlider.addEventListener('input', updateVolume);
            elements.audioPlayer.addEventListener('ended', playNext);
            elements.audioPlayer.addEventListener('error', handleAudioError);
            
            // Admin
            elements.loginBtn.addEventListener('click', login);
            elements.passwordInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') login();
            });
            
            // √Ålbuns
            elements.albumSelection.addEventListener('click', selectAlbum);
        }

        function switchMode(mode) {
            if (mode === 'public') {
                elements.publicMode.classList.add('active');
                elements.adminMode.classList.remove('active');
                elements.publicPlayer.style.display = 'block';
                elements.adminPanel.style.display = 'none';
            } else {
                elements.adminMode.classList.add('active');
                elements.publicMode.classList.remove('active');
                elements.publicPlayer.style.display = 'none';
                elements.adminPanel.style.display = 'block';
                
                if (!currentState.isLoggedIn) {
                    elements.passwordPrompt.style.display = 'block';
                    elements.adminContent.classList.add('hidden');
                } else {
                    elements.passwordPrompt.style.display = 'none';
                    elements.adminContent.classList.remove('hidden');
                    updateAdminPanel();
                }
            }
        }

        function login() {
            const password = elements.passwordInput.value;
            if (password === CONFIG.adminPassword) {
                currentState.isLoggedIn = true;
                elements.passwordPrompt.style.display = 'none';
                elements.adminContent.classList.remove('hidden');
                updateAdminPanel();
                showMessage('Login realizado com sucesso!', 'success');
            } else {
                showMessage('Senha incorreta!', 'error');
                elements.passwordInput.value = '';
            }
        }

        function loadVolume() {
            elements.volumeSlider.value = currentState.volume;
            elements.volumeValue.textContent = currentState.volume + '%';
            elements.audioPlayer.volume = currentState.volume / 100;
        }

        function updateVolume() {
            const volume = elements.volumeSlider.value;
            currentState.volume = volume;
            elements.volumeValue.textContent = volume + '%';
            elements.audioPlayer.volume = volume / 100;
            localStorage.setItem('volume', volume);
        }

        function updateAlbumCover() {
            const activeAlbum = currentState.activeAlbum;
            if (activeAlbum && CONFIG.albums[activeAlbum]) {
                elements.coverImage.src = CONFIG.albums[activeAlbum].image;
                elements.coverImage.style.display = 'block';
                elements.coverText.style.display = 'none';
            } else {
                elements.coverImage.style.display = 'none';
                elements.coverText.style.display = 'block';
                elements.coverText.textContent = 'üéµ Supermercado do Louro';
            }
        }

        function selectAlbum(e) {
            const albumCard = e.target.closest('.album-card');
            if (!albumCard) return;
            
            const album = albumCard.dataset.album;
            
            // Remove active de todos
            document.querySelectorAll('.album-card').forEach(card => {
                card.classList.remove('active');
            });
            
            if (album === 'none') {
                currentState.activeAlbum = null;
                localStorage.removeItem('activeAlbum');
                showMessage('√Ålbum desativado', 'success');
            } else {
                currentState.activeAlbum = album;
                localStorage.setItem('activeAlbum', album);
                albumCard.classList.add('active');
                showMessage(`√Ålbum ${CONFIG.albums[album].name} ativo`, 'success');
            }
            
            updateAlbumCover();
            updateStats();
        }

        async function togglePlay() {
            if (currentState.isPlaying) {
                pauseRadio();
            } else {
                await startRadio();
            }
        }

        async function startRadio() {
            try {
                elements.playBtn.textContent = '‚è∏Ô∏è Pausar';
                elements.playBtn.disabled = true;
                
                await loadFiles();
                
                if (currentState.allFiles.musicas.length === 0) {
                    showMessage('Nenhuma m√∫sica encontrada! Fa√ßa upload de arquivos primeiro.', 'error');
                    elements.playBtn.textContent = '‚ñ∂Ô∏è Iniciar R√°dio';
                    elements.playBtn.disabled = false;
                    return;
                }
                
                currentState.isPlaying = true;
                elements.playBtn.disabled = false;
                
                await playNext();
                
            } catch (error) {
                console.error('Erro ao iniciar r√°dio:', error);
                showMessage('Erro ao iniciar r√°dio: ' + error.message, 'error');
                elements.playBtn.textContent = '‚ñ∂Ô∏è Iniciar R√°dio';
                elements.playBtn.disabled = false;
            }
        }

        function pauseRadio() {
            currentState.isPlaying = false;
            elements.audioPlayer.pause();
            elements.playBtn.textContent = '‚ñ∂Ô∏è Continuar';
        }

        async function playNext() {
            if (!currentState.isPlaying) return;
            
            try {
                let nextTrack = null;
                let trackType = '';
                
                // L√≥gica de reprodu√ß√£o:
                // - Hora certa a cada 3 m√∫sicas
                // - Avisos a cada 6 m√∫sicas
                // - √Ålbum tem√°tico (se ativo) intercalado com m√∫sicas principais
                
                if (currentState.playCount > 0 && currentState.playCount % 3 === 0) {
                    // Tocar hora certa
                    if (currentState.allFiles['hora-certa'].length > 0) {
                        nextTrack = getRandomTrack('hora-certa');
                        trackType = 'üïê Hora Certa';
                    }
                } else if (currentState.playCount > 0 && currentState.playCount % 6 === 0) {
                    // Tocar aviso
                    if (currentState.allFiles.avisos.length > 0) {
                        nextTrack = getRandomTrack('avisos');
                        trackType = 'üì¢ Aviso';
                    }
                } else {
                    // Tocar m√∫sica (principal ou √°lbum tem√°tico)
                    if (currentState.activeAlbum && currentState.allFiles.albuns.length > 0 && Math.random() < 0.3) {
                        // 30% chance de tocar m√∫sica do √°lbum ativo
                        nextTrack = getRandomAlbumTrack();
                        trackType = `üéä ${CONFIG.albums[currentState.activeAlbum]?.name || '√Ålbum'}`;
                    } else {
                        // Tocar m√∫sica principal
                        nextTrack = getRandomTrack('musicas');
                        trackType = 'üéµ M√∫sica';
                    }
                }
                
                if (!nextTrack) {
                    // Fallback para m√∫sica principal
                    nextTrack = getRandomTrack('musicas');
                    trackType = 'üéµ M√∫sica';
                }
                
                if (!nextTrack) {
                    showMessage('Nenhuma m√∫sica dispon√≠vel!', 'error');
                    return;
                }
                
                await playTrack(nextTrack, trackType);
                
            } catch (error) {
                console.error('Erro ao tocar pr√≥xima m√∫sica:', error);
                showMessage('Erro na reprodu√ß√£o: ' + error.message, 'error');
            }
        }

        function getRandomTrack(category) {
            const files = currentState.allFiles[category];
            if (files.length === 0) return null;
            
            const randomIndex = Math.floor(Math.random() * files.length);
            return files[randomIndex];
        }

        function getRandomAlbumTrack() {
            const albumFiles = currentState.allFiles.albuns.filter(file => 
                file.name.toLowerCase().includes(currentState.activeAlbum)
            );
            
            if (albumFiles.length === 0) return null;
            
            const randomIndex = Math.floor(Math.random() * albumFiles.length);
            return albumFiles[randomIndex];
        }

        async function playTrack(track, trackType) {
            try {
                const audioUrl = `${SUPABASE_URL}/storage/v1/object/public/${track.bucket}/${track.name}`;
                
                elements.currentTrack.textContent = track.name.replace(/\.[^/.]+$/, ""); // Remove extens√£o
                elements.trackType.textContent = trackType;
                
                elements.audioPlayer.src = audioUrl;
                await elements.audioPlayer.play();
                
                // Registrar no relat√≥rio
                addToPlayReport(track.name, trackType);
                
                currentState.playCount++;
                updateStats();
                
            } catch (error) {
                console.error('Erro ao reproduzir:', error);
                throw error;
            }
        }

        function addToPlayReport(trackName, trackType) {
            const timestamp = new Date().toLocaleString('pt-BR');
            currentState.playReport.unshift({
                name: trackName,
                type: trackType,
                timestamp: timestamp
            });
            
            // Manter apenas os √∫ltimos 100 registros
            if (currentState.playReport.length > 100) {
                currentState.playReport = currentState.playReport.slice(0, 100);
            }
            
            localStorage.setItem('playReport', JSON.stringify(currentState.playReport));
            updatePlayReport();
        }

        function handleAudioError(e) {
            console.error('Erro no √°udio:', e);
            showMessage('Erro ao reproduzir arquivo de √°udio', 'error');
            
            // Tentar pr√≥xima m√∫sica ap√≥s 2 segundos
            setTimeout(() => {
                if (currentState.isPlaying) {
                    playNext();
                }
            }, 2000);
        }

        async function loadFiles() {
            try {
                for (const category of Object.keys(CONFIG.buckets)) {
                    const bucketName = CONFIG.buckets[category];
                    const files = await listFiles(bucketName);
                    currentState.allFiles[category] = files;
                }
                
                updateStats();
                
            } catch (error) {
                console.error('Erro ao carregar arquivos:', error);
                showMessage('Erro ao carregar arquivos: ' + error.message, 'error');
            }
        }

        async function listFiles(bucketName) {
            try {
                const response = await fetch(`${SUPABASE_URL}/storage/v1/object/list/${bucketName}`, {
                    headers: {
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                        'apikey': SUPABASE_ANON_KEY
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`Erro ao listar arquivos: ${response.statusText}`);
                }
                
                const data = await response.json();
                return data.map(file => ({
                    ...file,
                    bucket: bucketName
                }));
                
            } catch (error) {
                console.error(`Erro ao listar arquivos do bucket ${bucketName}:`, error);
                return [];
            }
        }

        async function uploadFiles(category) {
            const inputId = {
                'musicas': 'musicUpload',
                'hora-certa': 'timeUpload',
                'avisos': 'adUpload',
                'albuns': 'albumUpload'
            }[category];
            
            const fileInput = document.getElementById(inputId);
            const files = fileInput.files;
            
            if (files.length === 0) {
                showMessage('Selecione pelo menos um arquivo!', 'error');
                return;
            }
            
            const bucketName = CONFIG.buckets[category];
            let uploadedCount = 0;
            
            try {
                for (const file of files) {
                    await uploadFile(bucketName, file);
                    uploadedCount++;
                }
                
                showMessage(`${uploadedCount} arquivo(s) enviado(s) com sucesso!`, 'success');
                fileInput.value = ''; // Limpar input
                
                // Recarregar arquivos
                await loadFiles();
                updateFileList();
                
            } catch (error) {
                console.error('Erro no upload:', error);
                showMessage('Erro no upload: ' + error.message, 'error');
            }
        }

        async function uploadFile(bucketName, file) {
            const fileName = `${Date.now()}_${file.name}`;
            
            const response = await fetch(`${SUPABASE_URL}/storage/v1/object/${bucketName}/${fileName}`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                    'apikey': SUPABASE_ANON_KEY,
                    'Content-Type': file.type
                },
                body: file
            });
            
            if (!response.ok) {
                throw new Error(`Erro ao fazer upload: ${response.statusText}`);
            }
            
            return response.json();
        }

        async function deleteFile(bucketName, fileName) {
            try {
                const response = await fetch(`${SUPABASE_URL}/storage/v1/object/${bucketName}/${fileName}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                        'apikey': SUPABASE_ANON_KEY
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`Erro ao deletar arquivo: ${response.statusText}`);
                }
                
                showMessage('Arquivo deletado com sucesso!', 'success');
                await loadFiles();
                updateFileList();
                
            } catch (error) {
                console.error('Erro ao deletar arquivo:', error);
                showMessage('Erro ao deletar arquivo: ' + error.message, 'error');
            }
        }

        function updateStats() {
            const totalSongs = Object.values(currentState.allFiles).reduce((total, files) => total + files.length, 0);
            elements.totalSongs.textContent = totalSongs;
            elements.totalPlayed.textContent = currentState.playReport.length;
            elements.currentAlbum.textContent = currentState.activeAlbum ? 
                CONFIG.albums[currentState.activeAlbum]?.name || 'Desconhecido' : 'Nenhum';
        }

        function updateAdminPanel() {
            updateFileList();
            updatePlayReport();
            updateAlbumSelection();
        }

        function updateFileList() {
            let html = '';
            
            for (const [category, files] of Object.entries(currentState.allFiles)) {
                if (files.length > 0) {
                    html += `<h4>${getCategoryName(category)} (${files.length})</h4>`;
                    
                    for (const file of files) {
                        html += `
                            <div class="file-item">
                                <span>${file.name}</span>
                                <button class="delete-btn" onclick="deleteFile('${file.bucket}', '${file.name}')">üóëÔ∏è Deletar</button>
                            </div>
                        `;
                    }
                }
            }
            
            if (html === '') {
                html = '<div class="loading">Nenhum arquivo encontrado</div>';
            }
            
            elements.fileList.innerHTML = html;
        }

        function updatePlayReport() {
            let html = '';
            
            for (const item of currentState.playReport) {
                html += `
                    <div class="report-item">
                        <div>
                            <strong>${item.name}</strong><br>
                            <small>${item.type}</small>
                        </div>
                        <div>${item.timestamp}</div>
                    </div>
                `;
            }
            
            if (html === '') {
                html = '<div class="loading">Nenhuma m√∫sica tocada ainda</div>';
            }
            
            elements.playReport.innerHTML = html;
        }

        function updateAlbumSelection() {
            document.querySelectorAll('.album-card').forEach(card => {
                card.classList.remove('active');
                if (card.dataset.album === currentState.activeAlbum) {
                    card.classList.add('active');
                }
            });
        }

        function resetPlayReport() {
            if (confirm('Tem certeza que deseja resetar o relat√≥rio de reprodu√ß√£o?')) {
                currentState.playReport = [];
                localStorage.removeItem('playReport');
                updatePlayReport();
                updateStats();
                showMessage('Relat√≥rio resetado com sucesso!', 'success');
            }
        }

        function getCategoryName(category) {
            const names = {
                'musicas': 'üéµ M√∫sicas Principais',
                'hora-certa': 'üïê Hora Certa',
                'avisos': 'üì¢ Avisos',
                'albuns': 'üéä √Ålbuns Tem√°ticos'
            };
            return names[category] || category;
        }

        function showMessage(message, type) {
            // Remove mensagens existentes
            document.querySelectorAll('.error, .success').forEach(el => el.remove());
            
            const messageEl = document.createElement('div');
            messageEl.className = type;
            messageEl.textContent = message;
            
            document.querySelector('.container').insertBefore(messageEl, document.querySelector('.mode-buttons'));
            
            // Remove ap√≥s 5 segundos
            setTimeout(() => {
                messageEl.remove();
            }, 5000);
        }

        // Expor fun√ß√µes globais para os eventos onclick
        window.uploadFiles = uploadFiles;
        window.deleteFile = deleteFile;
        window.resetPlayReport = resetPlayReport;
    </script>
</body>
</html>
